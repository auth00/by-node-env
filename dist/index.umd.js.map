{"version":3,"file":"index.umd.js","sources":["../src/package-json.ts","../src/package-manager.ts","../src/node-env.ts","../src/process-env.ts","../src/program.ts","../src/remaining-argv.ts","../src/run-script.ts","../src/index.ts"],"sourcesContent":["import readPkgUp from 'read-pkg-up';\n\nexport const getPackageJson = ({ processCwd }: { processCwd: string }) => {\n  const packageJson = readPkgUp.sync({ cwd: processCwd });\n\n  if (packageJson) {\n    return packageJson.package;\n  }\n\n  return undefined;\n};\n","import preferredPM from 'preferred-pm';\nimport whichPMRuns from 'which-pm-runs';\n\nimport { getPackageJson } from './package-json';\n\nconst getPackageManagerFromPackageJson = ({\n  processCwd,\n}: {\n  processCwd: string;\n}) => {\n  const packageJson = getPackageJson({ processCwd });\n\n  if (packageJson && packageJson.engines) {\n    const { node, ...engines } = packageJson.engines;\n    const packageManagers = Object.keys(engines).filter(\n      (packageManager) => packageManager,\n    );\n\n    if (packageManagers[0]) {\n      return packageManagers[0];\n    }\n  }\n\n  return undefined;\n};\n\nconst getPackageManagerFromProcessEnv = ({\n  processEnv,\n}: {\n  processEnv: NodeJS.ProcessEnv;\n}) => {\n  if (processEnv.npm_execpath) {\n    return processEnv.npm_execpath;\n  }\n\n  const pm = whichPMRuns();\n\n  if (pm) {\n    return pm.name;\n  }\n\n  return undefined;\n};\n\nexport const getPreferredPackageManager = async ({\n  packageManager,\n  processCwd,\n  processEnv,\n}: {\n  packageManager?: string;\n  processCwd: string;\n  processEnv: NodeJS.ProcessEnv;\n}) => {\n  if (packageManager) {\n    return packageManager;\n  }\n\n  const packageManagerFromProcessEnv = getPackageManagerFromProcessEnv({\n    processEnv,\n  });\n\n  if (packageManagerFromProcessEnv) {\n    return packageManagerFromProcessEnv;\n  }\n\n  const pm = await preferredPM(processCwd);\n\n  if (pm) {\n    return pm.name;\n  }\n\n  const packageManagerFromPackageJson = getPackageManagerFromPackageJson({\n    processCwd,\n  });\n\n  if (packageManagerFromPackageJson) {\n    return packageManagerFromPackageJson;\n  }\n\n  return 'npm';\n};\n\nexport const getRunningPackageManager = ({\n  packageManager,\n  processEnv,\n}: {\n  packageManager?: string;\n  processEnv: NodeJS.ProcessEnv;\n}) => {\n  if (packageManager) {\n    return packageManager;\n  }\n\n  const packageManagerFromProcessEnv = getPackageManagerFromProcessEnv({\n    processEnv,\n  });\n\n  if (packageManagerFromProcessEnv) {\n    return packageManagerFromProcessEnv;\n  }\n\n  return 'npm';\n};\n","import fs from 'fs';\nimport path from 'path';\n\nimport dotenv from 'dotenv';\n\nexport const getNodeEnv = ({\n  envFile,\n  processCwd,\n  processEnv,\n}: {\n  envFile?: string;\n  processCwd: string;\n  processEnv: NodeJS.ProcessEnv;\n}) => {\n  if (processEnv.NODE_ENV) {\n    return processEnv.NODE_ENV;\n  }\n\n  if (envFile) {\n    const envPath = path.isAbsolute(envFile)\n      ? path.resolve(envFile)\n      : path.resolve(processCwd, envFile);\n    const envBuffer = fs.readFileSync(envPath);\n    const envConfig = dotenv.parse(envBuffer);\n\n    if (envConfig.NODE_ENV) {\n      return envConfig.NODE_ENV;\n    }\n  }\n\n  return 'development';\n};\n","import { getNodeEnv } from './node-env';\n\nexport const getProcessEnv = ({\n  envFile,\n  processCwd,\n  processEnv,\n}: {\n  envFile?: string;\n  processCwd: string;\n  processEnv: NodeJS.ProcessEnv;\n}): NodeJS.ProcessEnv & { NODE_ENV: string } => {\n  const nodeEnv = getNodeEnv({ envFile, processCwd, processEnv });\n\n  return { ...processEnv, NODE_ENV: nodeEnv };\n};\n","import program from 'commander';\n\nimport { getPackageJson } from './package-json';\n\nexport const getProgram = ({ processArgv }: { processArgv: string[] }) => {\n  program\n    .allowUnknownOption()\n    .option('-e, --env-file <path>', 'specify path to .env file')\n    .option(\n      '-p, --package-manager <pm>',\n      'specify package manager to run-script',\n    );\n\n  const packageJson = getPackageJson({ processCwd: __dirname });\n\n  if (packageJson) {\n    if (packageJson.description) {\n      program.description(packageJson.description);\n    }\n\n    program.version(packageJson.version);\n  }\n\n  program.parse(processArgv);\n\n  return program;\n};\n","import getUnknownArgs from 'commander-remaining-args';\n\nimport { getProgram } from './program';\n\nexport const getRemainingArgv = ({\n  program,\n  remainingArgv,\n}: {\n  program?: ReturnType<typeof getProgram>;\n  remainingArgv?: string[];\n}) => {\n  if (remainingArgv) {\n    return remainingArgv;\n  }\n\n  if (program) {\n    return getUnknownArgs(program);\n  }\n\n  return [];\n};\n","export const getRunScript = ({\n  processEnv,\n  runScript,\n}: {\n  processEnv: NodeJS.ProcessEnv;\n  runScript?: string;\n}) => {\n  if (runScript) {\n    return runScript;\n  }\n\n  if (processEnv.npm_lifecycle_event) {\n    return processEnv.npm_lifecycle_event;\n  }\n\n  return 'start';\n};\n","#!/usr/bin/env node\n\nimport execa from 'execa';\n\nimport {\n  getPreferredPackageManager,\n  getRunningPackageManager,\n} from './package-manager';\nimport { getProcessEnv } from './process-env';\nimport { getProgram } from './program';\nimport { getRemainingArgv } from './remaining-argv';\nimport { getRunScript } from './run-script';\n\nconst byNodeEnv = ({\n  packageManager,\n  processEnv,\n  remainingArgv,\n  runScript,\n}: {\n  packageManager: string;\n  processEnv: ReturnType<typeof getProcessEnv>;\n  remainingArgv: string[];\n  runScript: string;\n}) => {\n  const command = packageManager;\n  const args = ['run', `${runScript}:${processEnv.NODE_ENV}`, ...remainingArgv];\n  const options: execa.SyncOptions = { env: processEnv, stdio: 'inherit' };\n\n  return execa(command, args, options);\n};\n\nif (require.main === module || !module.parent) {\n  const processArgv = process.argv;\n  const processCwd = process.cwd();\n  const processEnv = process.env;\n\n  const program = getProgram({ processArgv });\n  const { envFile, packageManager } = program;\n\n  byNodeEnv({\n    packageManager: getRunningPackageManager({ packageManager, processEnv }),\n    processEnv: getProcessEnv({ envFile, processCwd, processEnv }),\n    remainingArgv: getRemainingArgv({ program }),\n    runScript: getRunScript({ processEnv }),\n  })\n    .then((childProcessResult) => {\n      process.exitCode = childProcessResult.exitCode;\n    })\n    .catch((childProcessResult: execa.ExecaError) => {\n      process.exitCode = childProcessResult.exitCode;\n    });\n}\n\nexport default ({\n  envFile,\n  packageManager,\n  processCwd = process.cwd(),\n  processEnv = process.env,\n  remainingArgv,\n  runScript,\n}: {\n  envFile?: string;\n  packageManager?: string;\n  processCwd?: string;\n  processEnv?: NodeJS.ProcessEnv;\n  remainingArgv?: string[];\n  runScript?: string;\n} = {}) =>\n  getPreferredPackageManager({ packageManager, processCwd, processEnv }).then(\n    (preferredPackageManager) =>\n      byNodeEnv({\n        packageManager: preferredPackageManager,\n        processEnv: getProcessEnv({ envFile, processCwd, processEnv }),\n        remainingArgv: getRemainingArgv({ remainingArgv }),\n        runScript: getRunScript({ processEnv, runScript }),\n      }),\n  );\n"],"names":["const","getPackageJson","packageJson","readPkgUp","sync","cwd","processCwd","package","undefined","getPackageManagerFromPackageJson","engines","packageManagers","Object","keys","filter","packageManager","getPackageManagerFromProcessEnv","processEnv","npm_execpath","pm","whichPMRuns","name","getPreferredPackageManager","packageManagerFromProcessEnv","preferredPM","packageManagerFromPackageJson","getRunningPackageManager","getNodeEnv","NODE_ENV","envFile","envPath","path","isAbsolute","resolve","envBuffer","fs","readFileSync","envConfig","dotenv","parse","getProcessEnv","nodeEnv","getProgram","program","allowUnknownOption","option","__dirname","description","version","processArgv","getRemainingArgv","remainingArgv","getUnknownArgs","getRunScript","runScript","npm_lifecycle_event","byNodeEnv","command","args","options","env","stdio","execa","require","main","module","parent","process","argv","then","childProcessResult","exitCode","catch","preferredPackageManager"],"mappings":"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"}