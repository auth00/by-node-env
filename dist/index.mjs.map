{"version":3,"file":"index.mjs","sources":["../src/index.ts"],"sourcesContent":["import { promises as fsPromises } from 'fs';\nimport path from 'path';\n\nimport dotenv from 'dotenv';\nimport execa from 'execa';\nimport preferredPM from 'preferred-pm';\nimport readPkgUp from 'read-pkg-up';\nimport whichPMRuns from 'which-pm-runs';\n\nconst getNodeEnv = async ({\n  cwd,\n  env,\n  envFile,\n}: {\n  cwd: string;\n  env: NodeJS.ProcessEnv;\n  envFile?: string;\n}): Promise<string> => {\n  if (env.NODE_ENV) {\n    return env.NODE_ENV;\n  }\n\n  if (envFile) {\n    const envPath = path.isAbsolute(envFile)\n      ? path.resolve(envFile)\n      : path.resolve(cwd, envFile);\n    const envBuffer = await fsPromises.readFile(envPath);\n    const envConfig = dotenv.parse(envBuffer);\n    if (envConfig.NODE_ENV) {\n      return envConfig.NODE_ENV;\n    }\n  }\n\n  return 'development';\n};\n\nconst getPackageManager = async ({\n  cwd,\n  env,\n  packageManager,\n}: {\n  cwd: string;\n  env: NodeJS.ProcessEnv;\n  packageManager?: string;\n}): Promise<string> => {\n  if (packageManager) {\n    return packageManager;\n  }\n\n  if (env.npm_execpath) {\n    return env.npm_execpath;\n  }\n\n  const pm = whichPMRuns() || (await preferredPM(cwd));\n  if (pm) {\n    return pm.name;\n  }\n\n  const readResult = await readPkgUp({ cwd });\n  if (readResult) {\n    const packageJson = readResult.package;\n    if (packageJson.engines) {\n      const { node, ...engines } = packageJson.engines;\n      const packageManagers = Object.keys(engines).filter((engine) => engine);\n      if (packageManagers[0]) {\n        return packageManagers[0];\n      }\n    }\n  }\n\n  return 'npm';\n};\n\nconst byNodeEnv = async ({\n  cwd = process.cwd(),\n  env = process.env,\n  envFile,\n  packageManager,\n  remainingArgv = [],\n  runScript = env.npm_lifecycle_event || 'start',\n}: {\n  cwd?: string;\n  env?: NodeJS.ProcessEnv;\n  envFile?: string;\n  packageManager?: string;\n  remainingArgv?: string[];\n  runScript?: string;\n} = {}): Promise<execa.ExecaReturnValue> => {\n  const NODE_ENV = await getNodeEnv({ cwd, env, envFile });\n\n  const command = await getPackageManager({ cwd, env, packageManager });\n  const args = ['run', `${runScript}:${NODE_ENV}`, ...remainingArgv];\n  const options: execa.Options = {\n    cwd,\n    env: { ...env, NODE_ENV },\n    stdio: 'inherit',\n  };\n\n  const childProcessResult = await execa(command, args, options).catch(\n    (childProcessResult: execa.ExecaError) => {\n      process.exitCode = childProcessResult.exitCode;\n      throw childProcessResult;\n    },\n  );\n\n  process.exitCode = childProcessResult.exitCode;\n  return childProcessResult;\n};\n\nexport default byNodeEnv;\n"],"names":["fsPromises"],"mappings":"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"}